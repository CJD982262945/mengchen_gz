<!DOCTYPE html>
<html lang="en">
<!--#include virtual="/ssi/header.html"-->

<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- Main Header -->
    <!--#include virtual="/ssi/main-header.html"-->

    <!-- Main sidebar -->
    <!--#include virtual="/ssi/agent/sidebar.html"-->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" id="app">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                梦晨
            </h1>
            <ol class="breadcrumb">
                <li><a href="/agent/home"><i class="fa fa-dashboard"></i>首页</a></li>
                <li>库存管理</li>
                <li class="active">申请记录</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">查看申请记录</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <template>
                        <!--<filter-bar></filter-bar>-->

                        <!--<div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfoTop"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="paginationTop"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>-->

                        <vuetable ref="vuetable"
                                  :api-url="vuetableUrl"
                                  :fields="fields"
                                  :sort-order="sortOrder"
                                  :css="css.table"
                                  pagination-path=""
                                  :per-page="15"
                                  :append-params="moreParams"
                                  @vuetable:pagination-data="onPaginationData"
                                  detail-row-component="detail-row"
                                  @vuetable:cell-clicked="onCellClicked"
                        ></vuetable>

                        <div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfo"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="pagination"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>
                    </template>

                </div>
                <!-- /.box-body -->
            </div>

        </section>
        <!-- /.content -->

    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <!--#include virtual="/ssi/main-footer.html"-->

</div>
<!-- ./wrapper -->

<script>
    Vue.use(Vuetable);      //注册vuetable-2插件
    var Hub = new Vue();    //event hub，事件中心，用于非父子组件中的事件传递

    //注册搜索条组件
    var filterBar = {
        template: `
            <div class="row" style="margin-right: 50px;margin-bottom: 8px;">
                <div class="input-group col-xs-4 pull-right">
                      <input type="text" v-model.trim="filterText" class="form-control" @keyup.enter="doFilter" placeholder="查找代理商账号...">
                      <span class="input-group-btn">
                        <button class="btn btn-flat" @click="doFilter">
                            <i class="glyphicon glyphicon-search"></i>
                        </button>
                      </span>
                </div>
            </div>`,
        data: function () {
            return {
                filterText: '',
            }
        },
        methods: {
            doFilter () {
                Hub.$emit('filterEvent', this.filterText);
            },
        }
    };
    Vue.component('filter-bar', filterBar);

    var app = new Vue({
        el: '#app',
        data: {
            vuetableUrl: '/agent/api/stock/history',

            activatedRow: {},       //选中的行

            stateType: {
                1: '待审核',
                2: '通过',
                3: '拒绝',
            },

            fields: [
                {
                    name: 'created_at',
                    title: '申请时间',
                    sortField: 'id',
                },
                {
                    name: 'applicant.name',
                    title: '申请人',
                },
                {
                    name: 'item.name',
                    title: '道具类型',
                    sortField: 'item_id',
                },
                {
                    name: 'amount',
                    title: '数量',
                    sortField: 'amount'
                },
                {
                    name: 'remark',
                    title: '备注',
                },
                {
                    name: 'approver.name',
                    title: '审批人',
                },
                {
                    name: 'updated_at',
                    title: '审批时间',
                    sortField: 'updated_at',
                },
                {
                    name: 'state',
                    title: '审核状态',
                    //dataClass: 'btn btn-block btn-success',
                    callback: 'transState',
                    sortField: 'state'
                }
            ],

            sortOrder: [
                {
                    field: 'id',
                    sortField: 'id',
                    direction: 'desc',
                }
            ],

            css: {
                table: {
                    tableClass: 'table table-striped table-bordered',
                    ascendingIcon: 'glyphicon glyphicon-chevron-up',
                    descendingIcon: 'glyphicon glyphicon-chevron-down',
                    handleIcon: 'glyphicon glyphicon-menu-hamburger',
                    renderIcon: function(classes, options) {
                        return `<span class="${classes.join(' ')}"></span>`
                    }
                },
                pagination: {
                    wrapperClass: "pagination pull-right",
                    activeClass: "btn-primary",
                    disabledClass: "disabled",
                    pageClass: "btn btn-border",
                    linkClass: "btn btn-border",
                    icons: {
                        first: "",
                        prev: "",
                        next: "",
                        last: ""
                    }
                }
            },

            moreParams: {},
        },

        methods: {
            onPaginationData (paginationData) {
                //this.$refs.paginationTop.setPaginationData(paginationData)
                //this.$refs.paginationInfoTop.setPaginationData(paginationData)

                //如果是待审核的，清空updated_at时间（后端laravel创建此条目时会将update_at和created_at填充成一样的）
                for (var [index, data] of paginationData.data.entries()) {
                    if (1 === data.state) {
                        paginationData.data[index]['updated_at'] = '';
                    }
                }
                this.$refs.pagination.setPaginationData(paginationData);
                this.$refs.paginationInfo.setPaginationData(paginationData);
            },
            onChangePage (page) {
                this.$refs.vuetable.changePage(page);
            },
            onCellClicked (data, field, event) {
                //console.log('cellClicked: ', field.name, data.email)
                //this.$refs.vuetable.toggleDetailRow(data.id);
            },

            transState (value) {
                switch(value)
                {
                    case 1:
                        return '<button class="btn btn-block btn-primary btn-flat">待审核</button>';
                    case 2:
                        return '<button class="btn btn-block btn-success btn-flat">通过</button>'
                    case 3:
                        return '<button class="btn btn-block btn-danger btn-flat">拒绝</button>'
                }
            },
        },

        mounted: function () {
            var _self = this;

            Hub.$on('filterEvent', function (filterText) {
                _self.moreParams = {
                    'filter': filterText,
                };
                Vue.nextTick(function (){
                    _self.$refs.vuetable.refresh();
                })
            });
        },
    });
</script>
</body>
</html>