<!DOCTYPE html>
<html lang="en">
<!--#include virtual="/ssi/header.html"-->

<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- Main Header -->
    <!--#include virtual="/ssi/main-header.html"-->

    <!-- Main sidebar -->
    <!--#include virtual="/ssi/admin/sidebar.html"-->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" id="app">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                梦晨
            </h1>
            <ol class="breadcrumb">
                <li><a href="/admin/home"><i class="fa fa-dashboard"></i> 首页</a></li>
                <li>公告管理</li>
                <li class="active">跑马灯</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">跑马灯公告</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <div class="row col-md-3">
                        <button class="btn btn-block btn-primary btn-flat" data-toggle="modal"
                                data-target="#new-marquee-modal">
                            新建跑马灯公告
                        </button>
                    </div>
                    <template>

                        <!--<div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfoTop"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="paginationTop"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>-->

                        <vuetable ref="vuetable"
                                  :api-url="vuetableUrl"
                                  :fields="tableFields"
                                  :sort-order="sortOrder"
                                  :css="css.table"
                                  pagination-path=""
                                  :per-page="15"
                                  :append-params="moreParams"
                                  @vuetable:pagination-data="onPaginationData"
                                  detail-row-component="detail-row"
                                  track-by="id"
                                  @vuetable:cell-clicked="onCellClicked"
                        ></vuetable>

                        <div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfo"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="pagination"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>
                    </template>

                </div>
                <!-- /.box-body -->
            </div>

        </section>
        <!-- /.content -->

        <!-- 新建跑马灯公告模态框 -->
        <div id="new-marquee-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog" style="width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" type="button" data-dismiss="modal">x</button>
                        <h3 class="text-center">新建跑马灯公告</h3>
                    </div>
                    <div class="modal-body">
                        <form role="form" class="form-group" method="POST" action="#" @submit.prevent="createMarquee">
                            <div class="form-group has-feedback">
                                <label>优先级</label>
                                <select class="form-control" v-model.trim="createMarqueeData.priority">
                                    <option v-for="(value, index) in priorityType" :value="index"
                                            v-if="index == createMarqueeData.priority" selected>
                                        {{ value }}
                                    </option>
                                    <option v-else :value="index">
                                        {{ value }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group has-feedback">
                                <label>时间间隔</label>
                                <input name="interval" type="number" min="1" required class="form-control"
                                       v-model.trim="createMarqueeData.interval" placeholder="单位：秒">
                                <span class="glyphicon glyphicon-time form-control-feedback"></span>
                            </div>
                            <div class="form-group has-feedback">
                                <label>开始时间</label>
                                <date-picker required :config='datePickerConf' v-model="createMarqueeData.start_at"
                                             placeholder="开始时间"></date-picker>
                                <span class="glyphicon glyphicon-calendar form-control-feedback"></span>
                            </div>
                            <div class="form-group has-feedback">
                                <label>结束时间</label>
                                <date-picker required :config='datePickerConf' v-model="createMarqueeData.end_at"
                                             placeholder="结束时间"></date-picker>
                                <span class="glyphicon glyphicon-calendar form-control-feedback"></span>
                            </div>
                            <div class="form-group">
                                <label>公告内容</label>
                                <textarea type="text" class="form-control" row="3" required placeholder="公告内容"
                                          v-model.trim="createMarqueeData.content"></textarea>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-block btn-flat" type="submit">提交</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑跑马灯公告模态框 -->
        <div id="edit-marquee-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog" style="width: 380px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" type="button" data-dismiss="modal">x</button>
                        <h3 class="text-center">编辑跑马灯公告</h3>
                    </div>
                    <div class="modal-body">
                        <form role="form" class="form-group" method="POST" action="#" @submit.prevent="editMarquee">
                            <div class="form-group has-feedback">
                                <label>优先级</label>
                                <select class="form-control" v-model.trim="activatedRow.priority">
                                    <option v-for="(value, index) in priorityType" :value="index"
                                            v-if="index == activatedRow.priority" selected>
                                        {{ value }}
                                    </option>
                                    <option v-else :value="index">
                                        {{ value }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group has-feedback">
                                <label>时间间隔</label>
                                <input name="interval" type="number" min="1" required class="form-control"
                                       v-model.trim="activatedRow.interval" placeholder="单位：秒">
                                <span class="glyphicon glyphicon-time form-control-feedback"></span>
                            </div>
                            <div class="form-group has-feedback">
                                <label>开始时间</label>
                                <date-picker required :config='datePickerConf' v-model.trim="activatedRow.start_at"
                                             placeholder="开始时间"></date-picker>
                                <span class="glyphicon glyphicon-calendar form-control-feedback"></span>
                            </div>
                            <div class="form-group has-feedback">
                                <label>结束时间</label>
                                <date-picker required :config='datePickerConf' v-model.trim="activatedRow.end_at"
                                             placeholder="结束时间"></date-picker>
                                <span class="glyphicon glyphicon-calendar form-control-feedback"></span>
                            </div>
                            <div class="form-group">
                                <label>公告内容</label>
                                <textarea type="text" class="form-control" row="3" required placeholder="公告内容"
                                          v-model.trim="activatedRow.content"></textarea>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary btn-block btn-flat" type="submit">提交</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <!--#include virtual="/ssi/main-footer.html"-->

</div>
<!-- ./wrapper -->

<script>
    Vue.component('date-picker', VueBootstrapDatetimePicker.default);   //注册date-picker组件

    Vue.use(Vuetable);      //注册vuetable-2插件
    var Hub = new Vue();    //event hub，事件中心，用于非父子组件中的事件传递

    //注册处理每行数据的组件
    var tableActions = {
        template: `
                <div class="table-actions">
                    <button class="btn btn-success btn-flat" @click="enableMarquee(rowData)">
                        开启
                    </button>
                    <button class="btn btn-warning btn-flat" @click="disableMarquee(rowData)">
                        关闭
                    </button>
                    <button class="btn btn-primary btn-flat" data-toggle="modal" data-target="#edit-marquee-modal"
                        @click="editMarqueeAction(rowData)">修改
                    </button>
                    <button class="btn btn-danger btn-flat"
                        @click="deleteMarqueeAction(rowData)">删除
                    </button>
                </div>`,
        props: {
            rowData: {
                type: Object,
                required: true
            },
            rowIndex: {
                type: Number
            }
        },
        methods: {
            enableMarquee (data) {
                var uri = `/admin/api/notification/marquee/enable/${data.id}`;
                axios.put(uri, {})
                    .then(function (response) {
                        if (response.data.error) {
                            return alert(response.data.error);
                        }
                        alert(response.data.message);
                        return Hub.$emit('enableMarqueeEvent', data);     //发送开启公告事件，刷新表格
                    })
                    .catch(function (err) {
                        console.log(err);
                    })
            },
            disableMarquee (data) {
                var uri = `/admin/api/notification/marquee/disable/${data.id}`;
                axios.put(uri, {})
                    .then(function (response) {
                        if (response.data.error) {
                            return alert(response.data.error);
                        }
                        alert(response.data.message);
                        return Hub.$emit('disableMarqueeEvent', data);     //发送停用公告事件，刷新表格
                    })
                    .catch(function (err) {
                        console.log(err);
                    })
            },
            editMarqueeAction (data) {
                Hub.$emit('editMarqueeEvent', data);
            },
            deleteMarqueeAction (data) {
                var uri = `/admin/api/notification/marquee/${data.id}`;
                axios.delete(uri, {})
                    .then(function (response) {
                        if (response.data.error) {
                            return alert(response.data.error);
                        }
                        alert(response.data.message);
                        return Hub.$emit('deleteMarqueeEvent', data);     //发送删除事件，刷新表格
                    })
                    .catch(function (err) {
                        console.log(err);
                    })
            }
        }
    }
    Vue.component('table-actions', tableActions);

    //注册Detail Row，达到点击每行显示更多信息的效果
    var detailRow = {
        template: `
            <div @click="onClick">
              <div class="">
                <label>失败原因:&nbsp;&nbsp;</label>
                <span>{{rowData.failed_description}}</span>
              </div>
              <div class="">
                <label>创建时间:&nbsp;&nbsp;</label>
                <span>{{rowData.created_at}}</span>
              </div>
              <div class="">
                <label>更新时间:&nbsp;&nbsp;</label>
                <span>{{rowData.updated_at}}</span>
              </div>
            </div>`,
        props: {
            rowData: {
                type: Object,
                required: true
            },
            rowIndex: {
                type: Number
            },
        },
        methods: {
            onClick (event) {
                //console.log('detail-row: on-click', event.target)
            }
        },
    }
    Vue.component('detail-row', detailRow);

    var app = new Vue({
        el: '#app',
        data: {
            vuetableUrl: '/admin/api/notification/marquee',

            activatedRow: {},       //待编辑的行

            datePickerConf: {       //datePicker配置项
                locale: moment().local('zh_cn'),
                format: 'YYYY-MM-DD HH:mm:ss',
            },

            priorityType: {         //跑马灯公告优先级
                1: '高',
                2: '低'
            },

            switchType: {           //公告开启状态
                1: '开启',
                2: '关闭'
            },

            syncState: {           //公告同步状态
                1: '未同步',
                2: '同步中',
                3: '同步成功',
                4: '同步失败',
            },

            createMarqueeData: {    //创建公告表单数据
                priority: 1,
                interval: null,
                start_at: null,
                end_at: null,
                content: null,
            },

            tableFields: [
                {
                    name: 'id',
                    title: '公告ID',
                    sortField: 'id',
                },
                {
                    name: 'priority',
                    title: '优先级',
                    callback: 'transPriority',
                },
                {
                    name: 'start_at',
                    title: '开始时间',
                    sortField: 'start_at',
                    callback: 'transStartTime'
                },
                {
                    name: 'end_at',
                    title: '结束时间',
                    sortField: 'end_at',
                    callback: 'transEndTime'
                },
                {
                    name: 'content',
                    title: '公告内容',
                },
                {
                    name: 'switch',
                    title: '开启状态',
                    sortField: 'switch',
                    callback: 'transSwitch'
                },
                {
                    name: 'sync_state',
                    title: '同步状态',
                    sortField: 'sync_state',
                    callback: 'transSyncState'
                },
                /*{
                    name: 'failed_description',
                    title: '同步失败原因',
                    callback: 'transDescription',
                },*/
                {
                    name: '__component:table-actions',
                    title: '操作',
                    titleClass: 'text-center',
                    dataClass: 'text-center',
                },
            ],

            sortOrder: [    //默认的排序
                {
                    field: 'id',
                    sortField: 'id',
                    direction: 'desc',
                }
            ],

            css: {
                table: {
                    tableClass: 'table table-striped table-bordered',
                    ascendingIcon: 'glyphicon glyphicon-chevron-up',
                    descendingIcon: 'glyphicon glyphicon-chevron-down',
                    handleIcon: 'glyphicon glyphicon-menu-hamburger',
                    renderIcon: function(classes, options) {
                        return `<span class="${classes.join(' ')}"></span>`
                    }
                },
                pagination: {
                    wrapperClass: "pagination pull-right",
                    activeClass: "btn-primary",
                    disabledClass: "disabled",
                    pageClass: "btn btn-border",
                    linkClass: "btn btn-border",
                    icons: {
                        first: "",
                        prev: "",
                        next: "",
                        last: ""
                    }
                }
            },

            moreParams: {},
        },

        methods: {
            onPaginationData (paginationData) {
                //this.$refs.paginationTop.setPaginationData(paginationData)
                //this.$refs.paginationInfoTop.setPaginationData(paginationData)

                this.$refs.pagination.setPaginationData(paginationData);
                this.$refs.paginationInfo.setPaginationData(paginationData);
            },
            onChangePage (page) {
                this.$refs.vuetable.changePage(page);
            },
            onCellClicked (data, field, event) {
                this.$refs.vuetable.toggleDetailRow(data.id);
            },

            transPriority (value) {
                return this.priorityType[value];
            },

            transSwitch (value) {
                return this.switchType[value];
            },

            transSyncState (value) {
                var state = this.syncState[value];
                switch (value)
                {
                    case 1:
                        return `<span><b>${state}</b></span>`;
                    case 2:
                        return `<span style="color: #00c0ef;"><b>${state}</b></span>`;
                    case 3:
                        return `<span style="color: #00a65a;"><b>${state}</b></span>`;
                    case 4:
                        return `<span style="color: #dd4b39;"><b>${state}</b></span>`;
                    default:
                        return true;
                }
            },

            transDescription (value) {
                return value ? `<span style="color: #dd4b39;"><b>${value}</b></span>` : null;
            },

            transStartTime (value) {
                //当编辑公告的时候，activatedRow待编辑的行的数据会与这一行显示的数据双向绑定
                //初次打开页面的时候，后端返回的是string格式的字符串，而编辑的时候绑定的是moment对象
                if (moment.isMoment(value)) {
                    return value.format('YYYY-MM-DD HH:mm:ss');
                }
                return value;
            },

            transEndTime (value) {
                if (moment.isMoment(value)) {
                    return value.format('YYYY-MM-DD HH:mm:ss');
                }
                return value;
            },

            createMarquee () {
                var formData = {};
                var _self = this;
                var startTime = _self.createMarqueeData.start_at;
                var endTime = _self.createMarqueeData.end_at;

                if (endTime.isBefore(startTime)) {
                    return alert('开始时间不能大于结束时间');
                }

                //重新构建formData，引用_self.createMarqueeData的值发送POST数据是start_at和end_数据格式不对
                formData.priority = _self.createMarqueeData.priority;
                formData.interval = _self.createMarqueeData.interval;
                formData.content = _self.createMarqueeData.content;
                //格式化moment对象为相应的字符串时间格式
                formData.start_at = startTime.format('YYYY-MM-DD HH:mm:ss');
                formData.end_at = endTime.format('YYYY-MM-DD HH:mm:ss');

                axios({
                    method: 'POST',
                    url: '/admin/api/notification/marquee',
                    data: formData,
                    validateStatus: function (status) {
                        return status == 200 || status == 422;
                    }
                })
                    .then(function (response) {
                        if (response.status === 422) {
                            return alert(JSON.stringify(response.data))
                        } else {
                            if (response.data.error) {
                                return alert(response.data.error)
                            }

                            alert(response.data.message);

                            //清空表单数据
                            for (var index of Object.keys(_self.createMarqueeData)) {
                                _self.createMarqueeData[index] = null;
                            }

                            //添加成功，刷新表格
                            Vue.nextTick(function (){
                                _self.$refs.vuetable.refresh();
                            });

                            return true;
                        }
                    })
                    .catch(function (err) {
                        alert(err);
                        console.log(err);
                    });
            },

            editMarquee () {
                var formData = {};
                var _self = this;
                var startTime = _self.activatedRow.start_at;
                var endTime = _self.activatedRow.end_at;

                if (endTime.isBefore(startTime)) {
                    return alert('开始时间不能大于结束时间');
                }

                //重新构建formData，引用_self.createMarqueeData的值发送POST数据是start_at和end_数据格式不对
                formData.priority = _self.activatedRow.priority;
                formData.interval = _self.activatedRow.interval;
                formData.content = _self.activatedRow.content;
                //格式化moment对象为相应的字符串时间格式
                formData.start_at = startTime.format('YYYY-MM-DD HH:mm:ss');
                formData.end_at = endTime.format('YYYY-MM-DD HH:mm:ss');
                axios({
                    method: 'PUT',
                    url: `/admin/api/notification/marquee/${_self.activatedRow.id}`,
                    data: formData,
                    validateStatus: function (status) {
                        return status == 200 || status == 422;
                    }
                })
                    .then(function (response) {
                        if (response.status === 422) {
                            return alert(JSON.stringify(response.data))
                        } else {
                            if (response.data.error) {
                                return alert(response.data.error)
                            }

                            alert(response.data.message);

                            //清空表单数据
                            for (var index of Object.keys(_self.activatedRow)) {
                                _self.activatedRow[index] = null;
                            }

                            //添加成功，刷新表格
                            Vue.nextTick(function (){
                                _self.$refs.vuetable.refresh();
                            });

                            return true;

                            response.data.error ? alert(response.data.error) : alert(response.data.message);
                            return true;
                        }
                    })
                    .catch(function (err) {
                        alert(err);
                        console.log(err);
                    });
            }
        },

        mounted: function () {
            var _self = this;

            Hub.$on('editMarqueeEvent', function (data) {
                _self.activatedRow = data;
            });
            Hub.$on('deleteMarqueeEvent', function (data) {
                //删除成功，刷新表格
                Vue.nextTick(function (){
                    _self.$refs.vuetable.refresh();
                })
            })
            Hub.$on('enableMarqueeEvent', function (data) {
                //启用成功，刷新表格
                Vue.nextTick(function (){
                    _self.$refs.vuetable.refresh();
                })
            });
            Hub.$on('disableMarqueeEvent', function (data) {
                //停用成功，刷新表格
                Vue.nextTick(function (){
                    _self.$refs.vuetable.refresh();
                })
            });
        },
    });
</script>
</body>
</html>