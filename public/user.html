<!DOCTYPE html>
<html lang="en">
<!--#include virtual="/ssi/header.html"-->

<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- Main Header -->
    <!--#include virtual="/ssi/main-header.html"-->

    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">

        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
            <!-- Sidebar Menu -->
            <ul class="sidebar-menu">
                <li class="header">HEADER</li>
                <!-- Optionally, you can add icons to the links -->
                <li class="active"><a href="/admin/"><i class="fa fa-users"></i> <span>用户管理</span></a></li>
                <li><a href="/admin/wangwang/approving"><i class="fa fa-user"></i> <span>旺旺信息审核</span></a></li>
                <li class="treeview">
                    <a href="#"><i class="fa fa-share"></i> <span>下拉菜单</span>
                        <span class="pull-right-container"><i class="fa fa-angle-left pull-right"></i></span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="#">Link in level 2</a></li>
                        <li><a href="#">Link in level 2</a></li>
                    </ul>
                </li>
            </ul>
            <!-- /.sidebar-menu -->
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper" id="app">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                用户管理
                <!--<small>注册用户</small>-->
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                <li class="active">User</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="box">
                <div class="box-header">
                    <!--<h3 class="box-title">用户列表</h3>-->
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <template>
                        <filter-bar></filter-bar>

                        <!--<div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfoTop"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="paginationTop"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>-->

                        <vuetable ref="vuetable"
                                  api-url="/admin/user/all"
                                  :fields="fields"
                                  :sort-order="sortOrder"
                                  :css="css.table"
                                  pagination-path=""
                                  :per-page="10"
                                  :append-params="moreParams"
                                  @vuetable:pagination-data="onPaginationData"
                                  detail-row-component="detail-row"
                                  @vuetable:cell-clicked="onCellClicked"
                        ></vuetable>

                        <div class="pagination pull-left">
                            <vuetable-pagination-info ref="paginationInfo"
                            ></vuetable-pagination-info>
                        </div>
                        <vuetable-pagination ref="pagination"
                                             :css="css.pagination"
                                             @vuetable-pagination:change-page="onChangePage"
                        ></vuetable-pagination>
                    </template>

                </div>
                <!-- /.box-body -->
            </div>

        </section>
        <!-- /.content -->

        <!-- User Table Actions -->
        <!--#include virtual="/ssi/user-table-actions.html"-->
    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <!--#include virtual="/ssi/main-footer.html"-->

</div>
<!-- ./wrapper -->

<script>
    Vue.use(Vuetable);      //注册vuetable-2插件
    Vue.use(VeeValidate);   //注册vee-validate插件
    var Hub = new Vue();    //event hub，事件中心，用于非父子组件中的事件传递

    //注册处理每行数据的组件
    var tableActions = {
        template: `
                <div class="table-actions">
                    <button class="btn btn-default" data-toggle="modal" data-target="#user-info-modal"
                        @click="editInfoAction(rowData)" title="编辑用户信息"><i class="glyphicon glyphicon-edit"></i>
                    </button>
                    <button class="btn btn-default" data-toggle="modal" data-target="#user-password-modal"
                        @click="changePasswordAction(rowData)" title="更改用户密码"><i class="glyphicon glyphicon-pencil"></i>
                    </button>
                    <button class="btn btn-default" data-toggle="modal" data-target="#delete-user-modal"
                        @click="deleteUserAction(rowData)" title="删除用户"><i class="glyphicon glyphicon-trash"></i>
                    </button>
                </div>`,
        props: {
            rowData: {
                type: Object,
                required: true
            },
            rowIndex: {
                type: Number
            }
        },
        methods: {
            editInfoAction (data) {
                Hub.$emit('editInfoEvent', data);
            },
            changePasswordAction (data) {
                Hub.$emit('changeUserPasswordEvent', data);
            },
            deleteUserAction (data) {
                Hub.$emit('deleteUserEvent', data);
            },
        }
    }
    Vue.component('table-actions', tableActions);

    //注册Detail Row，达到点击每行显示更多信息的效果
    var detailRow = {
        template: `
            <div @click="onClick">
              <div class="">
                <label>注册时间:&nbsp;&nbsp;</label>
                <span>{{rowData.created_at}}</span>
              </div>
              <div class="">
                <label>最后登录时间:&nbsp;&nbsp;</label>
                <span>{{rowData.updated_at}}</span>
              </div>
            </div>`,
        props: {
            rowData: {
                type: Object,
                required: true
            },
            rowIndex: {
                type: Number
            }
        },
        methods: {
            onClick (event) {
                //console.log('my-detail-row: on-click', event.target)
            }
        },
    }
    Vue.component('detail-row', detailRow);

    //注册搜索条组件
    var filterBar = {
        template: `
            <div class="row" style="margin-right: 50px;margin-bottom: 8px;">
                <div class="input-group col-xs-4 pull-right">
                      <input type="text" v-model.trim="filterText" class="form-control" @keyup.enter="doFilter" placeholder="查找...">
                      <span class="input-group-btn">
                        <button class="btn btn-flat" @click="doFilter">
                            <i class="glyphicon glyphicon-search"></i>
                        </button>
                      </span>
                </div>
            </div>`,
        data: function () {
            return {
                filterText: '',
            }
        },
        methods: {
            doFilter () {
                console.log('doFilter:', this.filterText);
                Hub.$emit('filterEvent', this.filterText);
            },
        }
    };
    Vue.component('filter-bar', filterBar);

    var app = new Vue({
        el: '#app',
        data: {
            rollType: {
                1: '普通用户',
                2: '管理员',
                3: 'vip用户'
            },

            activatedRow: {},       //待编辑的行

            editUserResponse: {     //编辑用户信息
                message: '',
                ifSuccess: false,
            },

            changePassword: {       //修改用户密码
                password: '',
                message: '',
                ifSuccess: false,
            },

            deleteUserResponse: {   //删除用户
                message: '',
                ifSuccess: false,
            },

            fields: [
                {
                    name: 'id',
                    title: 'ID',
                    sortField: 'id',
                },
                {
                    name: 'name',
                    title: '用户昵称',
                },
                {
                    name: 'email',
                    title: '用户邮箱',
                    sortField: 'email',
                },
                {
                    name: 'phone',
                    title: '用户手机',
                    visible: false,
                },
                {
                    name: 'roll_type',
                    title: '用户角色',
                    callback: 'getRollType',
                },
                {
                    name: '__component:table-actions',
                    title: '编辑',
                    titleClass: 'text-center',
                    dataClass: 'text-left',
                },
            ],

            sortOrder: [
                {
                    field: 'id',
                    sortField: 'id',
                    direction: 'desc',
                }
            ],

            css: {
                table: {
                    tableClass: 'table table-striped table-bordered',
                    ascendingIcon: 'glyphicon glyphicon-chevron-up',
                    descendingIcon: 'glyphicon glyphicon-chevron-down',
                    handleIcon: 'glyphicon glyphicon-menu-hamburger',
                    renderIcon: function(classes, options) {
                        return `<span class="${classes.join(' ')}"></span>`
                    }
                },
                pagination: {
                    wrapperClass: "pagination pull-right",
                    activeClass: "btn-primary",
                    disabledClass: "disabled",
                    pageClass: "btn btn-border",
                    linkClass: "btn btn-border",
                    icons: {
                        first: "",
                        prev: "",
                        next: "",
                        last: ""
                    }
                }
            },

            moreParams: {},
        },

        methods: {
            onPaginationData (paginationData) {
                //this.$refs.paginationTop.setPaginationData(paginationData)
                //this.$refs.paginationInfoTop.setPaginationData(paginationData)

                this.$refs.pagination.setPaginationData(paginationData);
                this.$refs.paginationInfo.setPaginationData(paginationData);
            },
            onChangePage (page) {
                this.$refs.vuetable.changePage(page);
            },
            onCellClicked (data, field, event) {
                //console.log('cellClicked: ', field.name, data.email)
                this.$refs.vuetable.toggleDetailRow(data.id);
            },

            getRollType (value) {
                return this.rollType[value];
            },
            editUserInfo () {
                var _self = this;

                if (this.errors.any()) { return false; }    //表单验证，验证失败不提交

                axios({
                    method: 'POST',
                    url: '/admin/user/' + this.activatedRow.id,
                    data: this.activatedRow,
                    timeout: 5000,                          //超时时间
                    xsrfCookieName: 'XSRF-TOKEN',
                    xsrfHeaderName: 'X-XSRF-TOKEN',
                    validateStatus: function (status) {     //定义哪些http状态返回码会被promise resolve
                        return status >= 200 && status < 500 && status != 404;
                    }
                })
                    .then(function (response) {
                        if (response.status === 422) {
                            _self.editUserResponse.ifSuccess = false;
                            _self.editUserResponse.message = JSON.stringify(response.data);
                            return false;
                        }
                        _self.editUserResponse.ifSuccess = true;
                        _self.editUserResponse.message = response.data.message;
                    })
                    .catch(function (err) {
                        alert(err);
                        console.log(err);
                    });
            },
            updateUserPassword () {
                var _self = this;

                if (this.errors.any()) { return false; }    //表单验证，验证失败不提交

                axios({
                    method: 'POST',
                    url: '/admin/user/password/' + this.activatedRow.id,
                    data: this.changePassword,
                    timeout: 5000,                          //超时时间
                    xsrfCookieName: 'XSRF-TOKEN',
                    xsrfHeaderName: 'X-XSRF-TOKEN',
                    validateStatus: function (status) {     //定义哪些http状态返回码会被promise resolve
                        return status >= 200 && status < 500 && status != 404;
                    }
                })
                    .then(function (response) {
                        if (response.status === 422) {
                            _self.changePassword.ifSuccess = false;
                            _self.changePassword.message = JSON.stringify(response.data);
                            return false;
                        }
                        _self.changePassword.ifSuccess = true;
                        _self.changePassword.message = response.data.message;
                    })
                    .catch(function (err) {
                        alert(err);
                        console.log(err);
                    });
            },
            deleteUser () {
                var _self = this;

                axios({
                    method: 'DELETE',
                    url: '/admin/user/' + this.activatedRow.id,
                    timeout: 5000,                          //超时时间
                    xsrfCookieName: 'XSRF-TOKEN',
                    xsrfHeaderName: 'X-XSRF-TOKEN',
                })
                    .then(function (response) {
                        _self.deleteUserResponse.ifSuccess = true;
                        _self.deleteUserResponse.message = response.data.message;

                        //删除完成用户之后重新刷新表格数据，避免被删除用户继续留存在表格中
                        Vue.nextTick(function (){
                            _self.$refs.vuetable.refresh();
                        })
                    })
                    .catch(function (err) {
                        alert(err);
                        console.log(err);
                    });
            },
        },

        mounted: function () {
            var _self = this;

            Hub.$on('editInfoEvent', function (data) {
                _self.activatedRow = data;
            });
            Hub.$on('changeUserPasswordEvent', function (data) {
                _self.activatedRow = data;
            });
            Hub.$on('deleteUserEvent', function (data) {
                _self.activatedRow = data;
            });
            Hub.$on('filterEvent', function (filterText) {
                _self.moreParams = {
                    'filter': filterText,
                };
                Vue.nextTick(function (){
                    _self.$refs.vuetable.refresh();
                })
            });
        },
    });
</script>
</body>
</html>